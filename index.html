<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trading Simulator â€“ Live Preview</title>
<!-- Canvas refresh to restore preview button -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:Inter,system-ui;background:#0d1117;color:#e6edf3}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#161b22;border-bottom:1px solid #30363d}
header h1{font-size:18px;margin:0}
header button{background:#238636;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer}
.container{padding:18px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.card{background:#161b22;border-radius:10px;padding:14px}
label{font-size:13px;opacity:.9}
input{width:100%;margin-top:4px;margin-bottom:8px;background:#0d1117;border:1px solid #30363d;color:#e6edf3;border-radius:6px;padding:6px}
input[type=checkbox]{width:auto}
canvas{background:#0d1117;margin-top:12px}
.summary{grid-column:1/-1;font-size:18px;margin-top:8px}
.tableWrap{grid-column:1/-1;max-height:320px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #30363d;padding:6px;text-align:right}
th{position:sticky;top:0;background:#161b22}
th:first-child,td:first-child{text-align:center}
.worst{background:#3a1c1c}
</style>
</head>
<body>
<header>
  <h1>Trading Strategy Simulator (Live Preview)</h1>
  <div>
    <button id="saveBtn">ðŸ’¾ Save Inputs</button>
    <button id="previewBtn">â–¶ Preview</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h3>Account</h3>
    <label>Starting Balance ($)</label><input id="start" value="50000" />
    <label>Years</label><input id="years" value="3" />
    <label>Tax %</label><input id="tax" value="30" />
    <label>Target Balance ($)</label><input id="target" value="200000" />
    <label>Monte Carlo Runs</label><input id="runs" value="500" />
  </div>

  <div class="card">
    <h3>Withdrawals (Monthly)</h3>
    <label>Year 1</label><input id="w1" value="0" />
    <label>Year 2</label><input id="w2" value="2000" />
    <label>Year 3</label><input id="w3" value="3000" />
    <label>Year 4</label><input id="w4" value="3000" />
    <label>Year 5</label><input id="w5" value="3000" />
    <label><input type="checkbox" id="noW1" /> No withdrawals Year 1</label>
  </div>

  <div class="card">
    <h3>Strategy A</h3>
    <label><input type="checkbox" id="en" checked /> Enable</label>
    <label>Risk %</label><input id="risk" value="1" />
    <label>Win Rate %</label><input id="win" value="50" />
    <label>R:R</label><input id="rr" value="2" />
    <label>Trades / Month</label><input id="trades" value="20" />
    <label>Trades Variability Â±</label><input id="varA" value="3" />
  </div>

  <div class="card">
    <h3>Strategy B</h3>
    <label><input type="checkbox" id="en2" /> Enable</label>
    <label>Risk %</label><input id="risk2" value="0.5" />
    <label>Win Rate %</label><input id="win2" value="45" />
    <label>R:R</label><input id="rr2" value="2" />
    <label>Trades / Month</label><input id="trades2" value="10" />
    <label>Trades Variability Â±</label><input id="varB" value="2" />
  </div>

  <div class="card">
    <h3>Strategy C</h3>
    <label><input type="checkbox" id="en3" /> Enable</label>
    <label>Risk %</label><input id="risk3" value="0.25" />
    <label>Win Rate %</label><input id="win3" value="55" />
    <label>R:R</label><input id="rr3" value="1.5" />
    <label>Trades / Month</label><input id="trades3" value="8" />
    <label>Trades Variability Â±</label><input id="varC" value="2" />
  </div>

  <div class="summary" id="summary">Click Preview to run simulation</div>

  <div style="grid-column:1/-1">
    <canvas id="equityChart" height="160"></canvas>
  </div>

  <div style="grid-column:1/-1">
    <canvas id="tradeChart" height="140"></canvas>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Month</th><th>Start</th><th>Gross</th><th>Tax</th><th>Withdraw</th><th>End</th><th>Trades</th><th>Wins</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
let equityChart, tradeChart;
const fmt = n => Number(n).toLocaleString(undefined,{maximumFractionDigits:0});

function runSimulation(){
  const startVal = +document.getElementById('start').value;
  const yearsN = +document.getElementById('years').value;
  const taxR = +document.getElementById('tax').value/100;
  const targetN = +document.getElementById('target').value;
  const runsN = +document.getElementById('runs').value;
  const w = [
    +document.getElementById('w1').value,
    +document.getElementById('w2').value,
    +document.getElementById('w3').value,
    +document.getElementById('w4').value,
    +document.getElementById('w5').value
  ];

  const strategies=[
    {e:'en',r:'risk',w:'win',rr:'rr',t:'trades',v:'varA'},
    {e:'en2',r:'risk2',w:'win2',rr:'rr2',t:'trades2',v:'varB'},
    {e:'en3',r:'risk3',w:'win3',rr:'rr3',t:'trades3',v:'varC'}
  ].map(s=>({
    enabled:document.getElementById(s.e),
    risk:document.getElementById(s.r),
    win:document.getElementById(s.w),
    rr:document.getElementById(s.rr),
    trades:document.getElementById(s.t),
    var:document.getElementById(s.v)
  }));

  const noW1=document.getElementById('noW1');
  let labels=[], equity=[], tradesSeries=[], winPctSeries=[], finalBalances=[], blowups=0;
  const tbody = document.getElementById('tbody'); tbody.innerHTML='';
  let above=0, worstGross=Infinity;

  for(let r=0;r<runsN;r++){
    let bal=startVal;
    for(let y=1;y<=yearsN;y++){
      for(let m=1;m<=12;m++){
        if(bal<=0){bal=0; continue;}
        let startBal=bal, gross=0, wins=0, tr=0;
        strategies.forEach(s=>{
          if(!s.enabled.checked) return;
          const base=+s.trades.value;
          const variability=+s.var.value;
          const tpm=Math.max(0, base + Math.floor(Math.random()*(2*variability+1)) - variability);
          tr+=tpm;
          for(let i=0;i<tpm;i++){
            const riskAmt=bal*(+s.risk.value/100);
            if(Math.random()<+s.win.value/100){wins++; bal+=riskAmt*+s.rr.value; gross+=riskAmt*+s.rr.value;}
            else{bal-=riskAmt; gross-=riskAmt;}
          }
        });
        const taxAmt=Math.max(0,gross)*taxR; bal-=taxAmt;
        const wd=(!(y===1 && noW1.checked)?(w[y-1]||0):0); bal-=wd;
        if(bal<0) bal=0;

        if(r===0){
          labels.push(labels.length+1);
          equity.push(bal);
          tradesSeries.push(tr);
          winPctSeries.push(tr>0 ? (wins/tr*100) : 0);
          const row=`<tr class="${gross<worstGross?'worst':''}"><td>${labels.length}</td><td>${fmt(startBal)}</td><td>${fmt(gross)}</td><td>${fmt(taxAmt)}</td><td>${fmt(wd)}</td><td>${fmt(bal)}</td><td>${tr}</td><td>${wins}</td></tr>`;
          if(gross<worstGross) worstGross=gross;
          tbody.innerHTML+=row;
        }
      }
    }
    finalBalances.push(bal);
    if(bal>=targetN) above++; if(bal<=0) blowups++;
  }

  document.getElementById('summary').innerText=
    `Ending Balance: $${fmt(equity.at(-1))} | â‰¥ Target: ${Math.round(above/runsN*100)}% | Blowâ€‘up: ${Math.round(blowups/runsN*100)}%`;

  if(equityChart) equityChart.destroy();
  equityChart=new Chart(document.getElementById('equityChart'),{
    type:'line',
    data:{labels,datasets:[{data:equity,borderColor:'#2ea043',backgroundColor:'rgba(46,160,67,.18)',fill:true,tension:0.25,pointRadius:0}]},
    options:{plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'$'+fmt(v)}}}}
  });

  if(tradeChart) tradeChart.destroy();
  tradeChart=new Chart(document.getElementById('tradeChart'),{
    data:{labels,datasets:[
      {type:'bar',label:'Trades Taken',data:tradesSeries,yAxisID:'y',backgroundColor:'rgba(140,140,140,0.6)',order:1},
      {type:'line',label:'Win %',data:winPctSeries,yAxisID:'y1',borderColor:'#58a6ff',backgroundColor:'#58a6ff',tension:0.3,pointRadius:2,order:0},{type:'line',label:'50% Threshold',data:labels.map(()=>50),yAxisID:'y1',borderColor:'#ff4d4d',borderWidth:1,pointRadius:0,fill:false,order:-1}
    ]},
    options:{interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#e6edf3'}}},scales:{y:{title:{display:true,text:'Trades'}},y1:{position:'right',min:0,max:100,title:{display:true,text:'Win %'},ticks:{callback:v=>v+'%'}}}}
  });
}

document.getElementById('previewBtn').onclick=runSimulation;
document.getElementById('saveBtn').onclick=()=>{
  document.querySelectorAll('input').forEach(i=>localStorage.setItem('sim_'+i.id,i.type==='checkbox'?i.checked:i.value));
  document.getElementById('summary').innerText='Inputs saved âœ”';
};
window.onload=()=>document.querySelectorAll('input').forEach(i=>{
  const v=localStorage.getItem('sim_'+i.id);
  if(v!==null) i.type==='checkbox'?i.checked=v==='true':i.value=v;
});
</script>
</body>
</html>
