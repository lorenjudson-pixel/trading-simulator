<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        h1 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .upload-section {
            background: #1a1f3a;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px dashed #3d4466;
        }

        .upload-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type="file"], input[type="text"] {
            background: #0f1329;
            border: 1px solid #3d4466;
            padding: 12px;
            border-radius: 6px;
            color: #e0e0e0;
            flex: 1;
            min-width: 200px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e2442 0%, #252b4a 100%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #3d4466;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }

        .stat-value.positive {
            color: #10b981;
        }

        .stat-value.negative {
            color: #ef4444;
        }

        .filters {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        select {
            background: #0f1329;
            border: 1px solid #3d4466;
            padding: 10px;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .trades-list {
            display: grid;
            gap: 20px;
        }

        .trade-card {
            background: #1a1f3a;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .trade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }

        .trade-card.win {
            border-left-color: #10b981;
        }

        .trade-card.tbd {
            border-left-color: #f59e0b;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .trade-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #fff;
        }

        .trade-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-win {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-loss {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .badge-tbd {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .trade-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            color: #9ca3af;
            font-size: 0.95em;
        }

        .trade-notes {
            margin: 15px 0;
            color: #d1d5db;
            line-height: 1.8;
        }

        .trade-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .trade-image {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            background: #0f1329;
            aspect-ratio: 16/9;
        }

        .trade-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .trade-image:hover img {
            transform: scale(1.05);
        }

        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-content {
            max-width: 95%;
            max-height: 95%;
            position: relative;
        }

        .fullscreen-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            color: white;
            font-size: 2em;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Trade Journal</h1>
            <div class="upload-section">
                <div class="upload-options">
                    <input type="file" id="fileInput" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                    <button onclick="processDocument()">Load Trades</button>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #0f1329; border-radius: 6px; font-size: 0.9em; color: #9ca3af;">
                    <strong style="color: #667eea;">üìù To load from Google Docs:</strong><br>
                    1. Open your Google Doc<br>
                    2. Go to <strong>File ‚Üí Download ‚Üí Microsoft Word (.docx)</strong><br>
                    3. Upload the downloaded file above
                </div>
            </div>
        </header>

        <div class="stats-grid" id="stats"></div>

        <div class="filters">
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search trades..." oninput="filterTrades()">
            <select id="instrumentFilter" onchange="filterTrades()">
                <option value="">All Instruments</option>
            </select>
            <select id="playTypeFilter" onchange="filterTrades()">
                <option value="">All Play Types</option>
            </select>
            <select id="resultFilter" onchange="filterTrades()">
                <option value="">All Results</option>
                <option value="win">Wins Only</option>
                <option value="loss">Losses Only</option>
                <option value="tbd">TBD Only</option>
            </select>
        </div>

        <div class="trades-list" id="tradesList"></div>
    </div>

    <div class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreen()">
        <button class="close-fullscreen" onclick="closeFullscreen()">√ó</button>
        <div class="fullscreen-content" onclick="event.stopPropagation()">
            <img id="fullscreenImage" src="" alt="Trade Chart">
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        let allTrades = [];

        async function processDocument() {
            const fileInput = document.getElementById('fileInput');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const arrayBuffer = e.target.result;
                    const result = await mammoth.convertToHtml({arrayBuffer: arrayBuffer});
                    parseTrades(result.value);
                };
                
                reader.readAsArrayBuffer(file);
            } else {
                alert('Please select a .docx file to upload');
            }
        }

        function parseTrades(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const elements = Array.from(doc.body.children);
            
            allTrades = [];
            let currentTrade = null;
            let currentDate = '';
            let lastH3WasPlayType = false;

            for (let i = 0; i < elements.length; i++) {
                const el = elements[i];
                const text = el.textContent.trim();
                const tagName = el.tagName.toLowerCase();
                
                // Detect headings by tag
                const isH1 = tagName === 'h1';
                const isH2 = tagName === 'h2';
                const isH3 = tagName === 'h3';
                
                // H1 = Date (may have multiple trades on same date)
                if (isH1 && text.match(/\d{1,2}\/\d{1,2}\/\d{2,4}/)) {
                    currentDate = text.trim();
                }
                // H2 = Instrument (starts a NEW trade)
                else if (isH2 && currentDate) {
                    // Save previous trade if exists
                    if (currentTrade && currentTrade.instrument) {
                        allTrades.push(currentTrade);
                    }
                    
                    // Start new trade
                    currentTrade = {
                        date: currentDate,
                        instrument: text.trim(),
                        playType: '',
                        result: '',
                        notes: '',
                        images: []
                    };
                    lastH3WasPlayType = false;
                }
                // H3 = First one is Play Type, Second one is Result (WIN/LOSS/TBD)
                else if (isH3 && currentTrade) {
                    const upperText = text.toUpperCase();
                    
                    // If we haven't set play type yet, this is it
                    if (!currentTrade.playType) {
                        currentTrade.playType = text.trim();
                        lastH3WasPlayType = true;
                    }
                    // Second H3 should be the result
                    else if (lastH3WasPlayType) {
                        if (upperText === 'WIN' || upperText === 'W') {
                            currentTrade.result = 'win';
                        } else if (upperText === 'LOSS' || upperText === 'L') {
                            currentTrade.result = 'loss';
                        } else if (upperText === 'TBD') {
                            currentTrade.result = 'tbd';
                        }
                        lastH3WasPlayType = false;
                    }
                }
                // Regular paragraph = Notes (collect once we have play type set)
                else if (currentTrade && currentTrade.playType && (tagName === 'p' || tagName === 'div') && text) {
                    currentTrade.notes += (currentTrade.notes ? ' ' : '') + text;
                }

                // Extract images - NOW collect images as soon as we have a current trade!
                const images = el.querySelectorAll('img');
                if (currentTrade && images.length > 0) {
                    images.forEach(img => {
                        if (img.src && !currentTrade.images.includes(img.src)) {
                            currentTrade.images.push(img.src);
                        }
                    });
                }
            }

            // Don't forget the last trade
            if (currentTrade && currentTrade.instrument) {
                allTrades.push(currentTrade);
            }

            // Enhanced debug output
            console.log('=== PARSED TRADES DEBUG ===');
            allTrades.forEach((trade, index) => {
                console.log(`Trade ${index + 1}:`, {
                    date: trade.date,
                    instrument: trade.instrument,
                    playType: trade.playType,
                    result: trade.result,
                    notesPreview: trade.notes.substring(0, 50) + '...',
                    imageCount: trade.images.length
                });
            });
            console.log('=========================');
            
            updateStats();
            updateFilters();
            displayTrades(allTrades);
        }

        function updateStats() {
            const stats = {
                total: allTrades.length,
                wins: allTrades.filter(t => t.result === 'win').length,
                losses: allTrades.filter(t => t.result === 'loss').length,
                tbd: allTrades.filter(t => t.result === 'tbd').length,
                winRate: 0
            };

            const completedTrades = stats.wins + stats.losses;
            stats.winRate = completedTrades > 0 ? ((stats.wins / completedTrades) * 100).toFixed(1) : 0;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value">${stats.total}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Wins</div>
                    <div class="stat-value positive">${stats.wins}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Losses</div>
                    <div class="stat-value negative">${stats.losses}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value ${stats.winRate >= 50 ? 'positive' : 'negative'}">${stats.winRate}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending (TBD)</div>
                    <div class="stat-value" style="color: #f59e0b;">${stats.tbd}</div>
                </div>
            `;

            document.getElementById('stats').innerHTML = statsHTML;
        }

        function updateFilters() {
            const instruments = [...new Set(allTrades.map(t => t.instrument).filter(i => i && i.length > 0))];
            const playTypes = [...new Set(allTrades.map(t => t.playType).filter(p => p && p.length > 0))];

            document.getElementById('instrumentFilter').innerHTML = 
                '<option value="">All Instruments</option>' +
                instruments.sort().map(i => `<option value="${i}">${i}</option>`).join('');

            document.getElementById('playTypeFilter').innerHTML = 
                '<option value="">All Play Types</option>' +
                playTypes.sort().map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function filterTrades() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const instrument = document.getElementById('instrumentFilter').value;
            const playType = document.getElementById('playTypeFilter').value;
            const result = document.getElementById('resultFilter').value;

            const filtered = allTrades.filter(trade => {
                const matchesSearch = !search || 
                    trade.notes.toLowerCase().includes(search) ||
                    trade.instrument.toLowerCase().includes(search) ||
                    trade.playType.toLowerCase().includes(search) ||
                    trade.date.toLowerCase().includes(search);
                
                const matchesInstrument = !instrument || trade.instrument === instrument;
                const matchesPlayType = !playType || trade.playType === playType;
                const matchesResult = !result || trade.result === result;

                return matchesSearch && matchesInstrument && matchesPlayType && matchesResult;
            });

            displayTrades(filtered);
        }

        function displayTrades(trades) {
            const container = document.getElementById('tradesList');

            if (trades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No trades found</h3>
                        <p>Upload a document or adjust your filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = trades.map(trade => `
                <div class="trade-card ${trade.result}">
                    <div class="trade-header">
                        <div class="trade-title">${trade.date}</div>
                        <span class="trade-badge badge-${trade.result}">
                            ${trade.result.toUpperCase()}
                        </span>
                    </div>
                    <div class="trade-meta">
                        <span>üìà ${trade.instrument || 'N/A'}</span>
                        <span>üéØ ${trade.playType || 'N/A'}</span>
                    </div>
                    <div class="trade-notes">${trade.notes}</div>
                    ${trade.images.length > 0 ? `
                        <div class="trade-images">
                            ${trade.images.map(img => `
                                <div class="trade-image" onclick="openFullscreen('${img}')">
                                    <img src="${img}" alt="Trade chart">
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function openFullscreen(imageSrc) {
            document.getElementById('fullscreenImage').src = imageSrc;
            document.getElementById('fullscreenOverlay').classList.add('active');
        }

        function closeFullscreen() {
            document.getElementById('fullscreenOverlay').classList.remove('active');
        }

        // Demo data for testing
        window.addEventListener('load', () => {
            const demoTrades = [
                {
                    date: '01/15/2026',
                    instrument: 'SPY',
                    playType: 'Call Spread',
                    result: 'win',
                    notes: 'Market showed strong bullish momentum. Entry at support level worked perfectly. Exited at target resistance.',
                    images: []
                },
                {
                    date: '01/14/2026',
                    instrument: 'QQQ',
                    playType: 'Iron Condor',
                    result: 'loss',
                    notes: 'Unexpected volatility spike caused breach on upside. Should have adjusted position earlier.',
                    images: []
                }
            ];
            
            allTrades = demoTrades;
            updateStats();
            updateFilters();
            displayTrades(allTrades);
        });
    </script>
</body>
</html>
