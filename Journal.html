<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid #2a2a2a;
        }

        h1 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .upload-section {
            background: #0f0f0f;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px dashed #2a2a2a;
        }

        .upload-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type="file"], input[type="text"] {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 12px;
            border-radius: 6px;
            color: #e0e0e0;
            flex: 1;
            min-width: 200px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .stats-container {
            margin-bottom: 30px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stats-header h2 {
            font-size: 1.8em;
            color: #8b9dff;
        }

        .stats-period {
            color: #b0b0b0;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid #2a2a2a;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.positive::before {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .stat-card.negative::before {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .stat-card.warning::before {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-label {
            color: #b0b0b0;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.up {
            color: #10b981;
        }

        .stat-change.down {
            color: #ef4444;
        }

        .charts-section {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #2a2a2a;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .chart-card {
            background: #0f0f0f;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #2a2a2a;
        }

        .chart-card h3 {
            color: #8b9dff;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bar-label {
            min-width: 100px;
            color: #b0b0b0;
            font-size: 0.9em;
        }

        .bar-container {
            flex: 1;
            height: 30px;
            background: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .bar-fill.win {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .bar-fill.loss {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .donut-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-percentage {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
        }

        .donut-label {
            color: #b0b0b0;
            font-size: 0.9em;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #8b9dff;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #b0b0b0;
            font-size: 0.85em;
        }

        .stat-value.positive {
            color: #10b981;
        }

        .stat-value.negative {
            color: #ef4444;
        }

        .filters {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            border: 1px solid #2a2a2a;
        }

        select {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 10px;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .trades-list {
            display: grid;
            gap: 20px;
        }

        .trade-card {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border-left: 4px solid #667eea;
            border: 1px solid #2a2a2a;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .trade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .trade-card.win {
            border-left-color: #10b981;
        }

        .trade-card.tbd {
            border-left-color: #f59e0b;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .trade-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #fff;
        }

        .trade-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-win {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-loss {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .badge-tbd {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .trade-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            color: #9ca3af;
            font-size: 0.95em;
        }

        .trade-notes {
            margin: 15px 0;
            color: #d1d5db;
            line-height: 1.8;
        }

        .trade-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .trade-image {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            background: #0f0f0f;
            aspect-ratio: 16/9;
            border: 1px solid #2a2a2a;
        }

        .trade-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .trade-image:hover img {
            transform: scale(1.05);
        }

        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-content {
            max-width: 95%;
            max-height: 95%;
            position: relative;
        }

        .fullscreen-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .fullscreen-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(102, 126, 234, 0.9);
            border: none;
            color: white;
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .fullscreen-nav:hover {
            background: rgba(102, 126, 234, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .fullscreen-nav.prev {
            left: 30px;
        }

        .fullscreen-nav.next {
            right: 30px;
        }

        .fullscreen-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .fullscreen-nav:disabled:hover {
            transform: translateY(-50%) scale(1);
            background: rgba(102, 126, 234, 0.9);
        }

        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            color: white;
            font-size: 2em;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Trade Journal</h1>
            <div class="upload-section">
                <div class="upload-options">
                    <input type="file" id="fileInput" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                    <button onclick="processDocument()">Load Trades</button>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #0f1329; border-radius: 6px; font-size: 0.9em; color: #9ca3af;">
                    <strong style="color: #667eea;">üìù To load from Google Docs:</strong><br>
                    1. Open your Google Doc<br>
                    2. Go to <strong>File ‚Üí Download ‚Üí Microsoft Word (.docx)</strong><br>
                    3. Upload the downloaded file above
                </div>
            </div>
        </header>

        <div class="stats-container" id="statsContainer"></div>

        <div class="filters">
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search trades..." oninput="filterTrades()">
            <select id="instrumentFilter" onchange="filterTrades()">
                <option value="">All Instruments</option>
            </select>
            <select id="playTypeFilter" onchange="filterTrades()">
                <option value="">All Play Types</option>
            </select>
            <select id="resultFilter" onchange="filterTrades()">
                <option value="">All Results</option>
                <option value="win">Wins Only</option>
                <option value="loss">Losses Only</option>
                <option value="tbd">TBD Only</option>
            </select>
        </div>

        <div class="trades-list" id="tradesList"></div>
    </div>

    <div class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreen()">
        <button class="close-fullscreen" onclick="closeFullscreen()">√ó</button>
        <button class="fullscreen-nav prev" id="prevImage" onclick="event.stopPropagation(); navigateImage(-1)">‚Äπ</button>
        <button class="fullscreen-nav next" id="nextImage" onclick="event.stopPropagation(); navigateImage(1)">‚Ä∫</button>
        <div class="fullscreen-content" onclick="event.stopPropagation()">
            <img id="fullscreenImage" src="" alt="Trade Chart">
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        let allTrades = [];
        let currentImageIndex = 0;
        let currentTradeImages = [];

        async function processDocument() {
            const fileInput = document.getElementById('fileInput');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const arrayBuffer = e.target.result;
                    const result = await mammoth.convertToHtml({arrayBuffer: arrayBuffer});
                    parseTrades(result.value);
                };
                
                reader.readAsArrayBuffer(file);
            } else {
                alert('Please select a .docx file to upload');
            }
        }

        function parseTrades(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const elements = Array.from(doc.body.children);
            
            allTrades = [];
            let currentTrade = null;
            let currentDate = '';
            let lastH3WasPlayType = false;

            for (let i = 0; i < elements.length; i++) {
                const el = elements[i];
                const text = el.textContent.trim();
                const tagName = el.tagName.toLowerCase();
                
                // Detect headings by tag
                const isH1 = tagName === 'h1';
                const isH2 = tagName === 'h2';
                const isH3 = tagName === 'h3';
                
                // H1 = Date (may have multiple trades on same date)
                if (isH1 && text.match(/\d{1,2}\/\d{1,2}\/\d{2,4}/)) {
                    currentDate = text.trim();
                }
                // H2 = Instrument (starts a NEW trade)
                else if (isH2 && currentDate) {
                    // Save previous trade if exists
                    if (currentTrade && currentTrade.instrument) {
                        allTrades.push(currentTrade);
                    }
                    
                    // Start new trade
                    currentTrade = {
                        date: currentDate,
                        instrument: text.trim(),
                        playType: '',
                        result: '',
                        notes: '',
                        images: []
                    };
                    lastH3WasPlayType = false;
                }
                // H3 = First one is Play Type, Second one is Result (WIN/LOSS/TBD)
                else if (isH3 && currentTrade) {
                    const upperText = text.toUpperCase();
                    
                    // If we haven't set play type yet, this is it
                    if (!currentTrade.playType) {
                        currentTrade.playType = text.trim();
                        lastH3WasPlayType = true;
                    }
                    // Second H3 should be the result
                    else if (lastH3WasPlayType) {
                        if (upperText === 'WIN' || upperText === 'W') {
                            currentTrade.result = 'win';
                        } else if (upperText === 'LOSS' || upperText === 'L') {
                            currentTrade.result = 'loss';
                        } else if (upperText === 'TBD') {
                            currentTrade.result = 'tbd';
                        }
                        lastH3WasPlayType = false;
                    }
                }
                // Regular paragraph = Notes (collect once we have play type set)
                else if (currentTrade && currentTrade.playType && (tagName === 'p' || tagName === 'div') && text) {
                    currentTrade.notes += (currentTrade.notes ? ' ' : '') + text;
                }

                // Extract images - NOW collect images as soon as we have a current trade!
                const images = el.querySelectorAll('img');
                if (currentTrade && images.length > 0) {
                    images.forEach(img => {
                        if (img.src && !currentTrade.images.includes(img.src)) {
                            currentTrade.images.push(img.src);
                        }
                    });
                }
            }

            // Don't forget the last trade
            if (currentTrade && currentTrade.instrument) {
                allTrades.push(currentTrade);
            }

            // Enhanced debug output
            console.log('=== PARSED TRADES DEBUG ===');
            allTrades.forEach((trade, index) => {
                console.log(`Trade ${index + 1}:`, {
                    date: trade.date,
                    instrument: trade.instrument,
                    playType: trade.playType,
                    result: trade.result,
                    notesPreview: trade.notes.substring(0, 50) + '...',
                    imageCount: trade.images.length
                });
            });
            console.log('=========================');
            
            updateStats();
            updateFilters();
            displayTrades(allTrades);
        }

        function updateStats() {
            const filteredTrades = getFilteredTrades();
            
            const stats = {
                total: filteredTrades.length,
                wins: filteredTrades.filter(t => t.result === 'win').length,
                losses: filteredTrades.filter(t => t.result === 'loss').length,
                tbd: filteredTrades.filter(t => t.result === 'tbd').length,
                winRate: 0,
                avgWinStreak: 0,
                longestWinStreak: 0,
                longestLossStreak: 0
            };

            const completedTrades = stats.wins + stats.losses;
            stats.winRate = completedTrades > 0 ? ((stats.wins / completedTrades) * 100).toFixed(1) : 0;

            // Calculate streaks
            let currentStreak = 0;
            let maxWinStreak = 0;
            let maxLossStreak = 0;
            let lastResult = null;

            filteredTrades.filter(t => t.result !== 'tbd').forEach(trade => {
                if (trade.result === lastResult) {
                    currentStreak++;
                } else {
                    if (lastResult === 'win') maxWinStreak = Math.max(maxWinStreak, currentStreak);
                    if (lastResult === 'loss') maxLossStreak = Math.max(maxLossStreak, currentStreak);
                    currentStreak = 1;
                    lastResult = trade.result;
                }
            });
            if (lastResult === 'win') maxWinStreak = Math.max(maxWinStreak, currentStreak);
            if (lastResult === 'loss') maxLossStreak = Math.max(maxLossStreak, currentStreak);

            stats.longestWinStreak = maxWinStreak;
            stats.longestLossStreak = maxLossStreak;

            // Get instrument and play type breakdowns
            const instrumentStats = {};
            const playTypeStats = {};

            filteredTrades.forEach(trade => {
                if (trade.result !== 'tbd') {
                    // Instruments
                    if (!instrumentStats[trade.instrument]) {
                        instrumentStats[trade.instrument] = { wins: 0, total: 0 };
                    }
                    instrumentStats[trade.instrument].total++;
                    if (trade.result === 'win') instrumentStats[trade.instrument].wins++;

                    // Play Types
                    if (!playTypeStats[trade.playType]) {
                        playTypeStats[trade.playType] = { wins: 0, total: 0 };
                    }
                    playTypeStats[trade.playType].total++;
                    if (trade.result === 'win') playTypeStats[trade.playType].wins++;
                }
            });

            const statsHTML = `
                <div class="stats-header">
                    <h2>Performance Dashboard</h2>
                    <div class="stats-period">Showing ${stats.total} trade${stats.total !== 1 ? 's' : ''}</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-change">${completedTrades} completed, ${stats.tbd} pending</div>
                    </div>
                    <div class="stat-card positive">
                        <div class="stat-label">Wins</div>
                        <div class="stat-value positive">${stats.wins}</div>
                        <div class="stat-change">${completedTrades > 0 ? ((stats.wins/completedTrades)*100).toFixed(0) : 0}% of completed</div>
                    </div>
                    <div class="stat-card negative">
                        <div class="stat-label">Losses</div>
                        <div class="stat-value negative">${stats.losses}</div>
                        <div class="stat-change">${completedTrades > 0 ? ((stats.losses/completedTrades)*100).toFixed(0) : 0}% of completed</div>
                    </div>
                    <div class="stat-card ${stats.winRate >= 50 ? 'positive' : 'negative'}">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value ${stats.winRate >= 50 ? 'positive' : 'negative'}">${stats.winRate}%</div>
                        <div class="stat-change">${completedTrades} completed trades</div>
                    </div>
                    <div class="stat-card positive">
                        <div class="stat-label">Best Win Streak</div>
                        <div class="stat-value">${stats.longestWinStreak}</div>
                        <div class="stat-change">consecutive wins</div>
                    </div>
                    <div class="stat-card negative">
                        <div class="stat-label">Worst Loss Streak</div>
                        <div class="stat-value">${stats.longestLossStreak}</div>
                        <div class="stat-change">consecutive losses</div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>üìä Win Rate Overview</h3>
                            <div class="donut-chart">
                                <svg width="200" height="200" viewBox="0 0 200 200">
                                    <circle cx="100" cy="100" r="80" fill="none" stroke="#2a2a2a" stroke-width="35"/>
                                    <circle cx="100" cy="100" r="80" fill="none" 
                                        stroke="url(#winGradient)" 
                                        stroke-width="35"
                                        stroke-dasharray="${(stats.winRate * 502.65) / 100} 502.65"
                                        transform="rotate(-90 100 100)"
                                        stroke-linecap="round"/>
                                    <defs>
                                        <linearGradient id="winGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="donut-center">
                                    <div class="donut-percentage">${stats.winRate}%</div>
                                    <div class="donut-label">Win Rate</div>
                                </div>
                            </div>
                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #10b981;"></div>
                                    <span>${stats.wins} Wins</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #ef4444;"></div>
                                    <span>${stats.losses} Losses</span>
                                </div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <h3>üéØ Top Instruments</h3>
                            <div class="bar-chart">
                                ${Object.entries(instrumentStats)
                                    .sort((a, b) => b[1].total - a[1].total)
                                    .slice(0, 5)
                                    .map(([instrument, data]) => {
                                        const winRate = (data.wins / data.total * 100).toFixed(0);
                                        const maxTotal = Math.max(...Object.values(instrumentStats).map(d => d.total));
                                        const width = (data.total / maxTotal * 100);
                                        return `
                                            <div class="bar-item">
                                                <div class="bar-label">${instrument}</div>
                                                <div class="bar-container">
                                                    <div class="bar-fill" style="width: ${width}%">
                                                        ${data.total} (${winRate}%)
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') || '<div style="color: #b0b0b0; text-align: center; padding: 20px;">No data available</div>'}
                            </div>
                        </div>

                        <div class="chart-card">
                            <h3>üé≤ Play Type Performance</h3>
                            <div class="bar-chart">
                                ${Object.entries(playTypeStats)
                                    .sort((a, b) => (b[1].wins/b[1].total) - (a[1].wins/a[1].total))
                                    .slice(0, 5)
                                    .map(([playType, data]) => {
                                        const winRate = (data.wins / data.total * 100);
                                        const isWinning = winRate >= 50;
                                        return `
                                            <div class="bar-item">
                                                <div class="bar-label">${playType}</div>
                                                <div class="bar-container">
                                                    <div class="bar-fill ${isWinning ? 'win' : 'loss'}" style="width: ${winRate}%">
                                                        ${winRate.toFixed(0)}%
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') || '<div style="color: #b0b0b0; text-align: center; padding: 20px;">No data available</div>'}
                            </div>
                        </div>

                        <div class="chart-card">
                            <h3>üìà Quick Metrics</h3>
                            <div class="metric-grid">
                                <div class="metric-item">
                                    <div class="metric-value">${Object.keys(instrumentStats).length}</div>
                                    <div class="metric-label">Instruments</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${Object.keys(playTypeStats).length}</div>
                                    <div class="metric-label">Play Types</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${stats.tbd}</div>
                                    <div class="metric-label">Pending</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${completedTrades}</div>
                                    <div class="metric-label">Completed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('statsContainer').innerHTML = statsHTML;
        }

        function getFilteredTrades() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const instrument = document.getElementById('instrumentFilter').value;
            const playType = document.getElementById('playTypeFilter').value;
            const result = document.getElementById('resultFilter').value;

            return allTrades.filter(trade => {
                const matchesSearch = !search || 
                    trade.notes.toLowerCase().includes(search) ||
                    trade.instrument.toLowerCase().includes(search) ||
                    trade.playType.toLowerCase().includes(search) ||
                    trade.date.toLowerCase().includes(search);
                
                const matchesInstrument = !instrument || trade.instrument === instrument;
                const matchesPlayType = !playType || trade.playType === playType;
                const matchesResult = !result || trade.result === result;

                return matchesSearch && matchesInstrument && matchesPlayType && matchesResult;
            });
        }

        function updateFilters() {
            const instruments = [...new Set(allTrades.map(t => t.instrument).filter(i => i && i.length > 0))];
            const playTypes = [...new Set(allTrades.map(t => t.playType).filter(p => p && p.length > 0))];

            document.getElementById('instrumentFilter').innerHTML = 
                '<option value="">All Instruments</option>' +
                instruments.sort().map(i => `<option value="${i}">${i}</option>`).join('');

            document.getElementById('playTypeFilter').innerHTML = 
                '<option value="">All Play Types</option>' +
                playTypes.sort().map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function filterTrades() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const instrument = document.getElementById('instrumentFilter').value;
            const playType = document.getElementById('playTypeFilter').value;
            const result = document.getElementById('resultFilter').value;

            const filtered = allTrades.filter(trade => {
                const matchesSearch = !search || 
                    trade.notes.toLowerCase().includes(search) ||
                    trade.instrument.toLowerCase().includes(search) ||
                    trade.playType.toLowerCase().includes(search) ||
                    trade.date.toLowerCase().includes(search);
                
                const matchesInstrument = !instrument || trade.instrument === instrument;
                const matchesPlayType = !playType || trade.playType === playType;
                const matchesResult = !result || trade.result === result;

                return matchesSearch && matchesInstrument && matchesPlayType && matchesResult;
            });

            displayTrades(filtered);
        }

        function displayTrades(trades) {
            const container = document.getElementById('tradesList');

            if (trades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No trades found</h3>
                        <p>Upload a document or adjust your filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = trades.map(trade => `
                <div class="trade-card ${trade.result}">
                    <div class="trade-header">
                        <div class="trade-title">${trade.date}</div>
                        <span class="trade-badge badge-${trade.result}">
                            ${trade.result.toUpperCase()}
                        </span>
                    </div>
                    <div class="trade-meta">
                        <span>üìà ${trade.instrument || 'N/A'}</span>
                        <span>üéØ ${trade.playType || 'N/A'}</span>
                    </div>
                    <div class="trade-notes">${trade.notes}</div>
                    ${trade.images.length > 0 ? `
                        <div class="trade-images">
                            ${trade.images.map((img, idx) => `
                                <div class="trade-image" onclick="openFullscreen(${allTrades.indexOf(trade)}, ${idx})">
                                    <img src="${img}" alt="Trade chart">
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function openFullscreen(tradeIndex, imageIndex) {
            currentTradeImages = allTrades[tradeIndex].images;
            currentImageIndex = imageIndex;
            updateFullscreenImage();
            document.getElementById('fullscreenOverlay').classList.add('active');
        }

        function updateFullscreenImage() {
            document.getElementById('fullscreenImage').src = currentTradeImages[currentImageIndex];
            
            // Update navigation buttons
            document.getElementById('prevImage').disabled = currentImageIndex === 0;
            document.getElementById('nextImage').disabled = currentImageIndex === currentTradeImages.length - 1;
        }

        function navigateImage(direction) {
            currentImageIndex += direction;
            if (currentImageIndex < 0) currentImageIndex = 0;
            if (currentImageIndex >= currentTradeImages.length) currentImageIndex = currentTradeImages.length - 1;
            updateFullscreenImage();
        }

        function closeFullscreen() {
            document.getElementById('fullscreenOverlay').classList.remove('active');
        }

        // Demo data for testing
        window.addEventListener('load', () => {
            const demoTrades = [
                {
                    date: '01/15/2026',
                    instrument: 'SPY',
                    playType: 'Call Spread',
                    result: 'win',
                    notes: 'Market showed strong bullish momentum. Entry at support level worked perfectly. Exited at target resistance.',
                    images: []
                },
                {
                    date: '01/14/2026',
                    instrument: 'QQQ',
                    playType: 'Iron Condor',
                    result: 'loss',
                    notes: 'Unexpected volatility spike caused breach on upside. Should have adjusted position earlier.',
                    images: []
                }
            ];
            
            allTrades = demoTrades;
            updateStats();
            updateFilters();
            displayTrades(allTrades);
        });
    </script>
</body>
</html>
